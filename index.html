<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gravity Intel V17.5 | Extended</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        :root { --accent: #00f2ff; --bg: #050505; --card: #0f0f10; }
        body { font-family: 'JetBrains Mono', monospace; background: var(--bg); color: var(--accent); margin: 0; overflow: hidden; height: 100vh; font-size: 16px; }
        
        /* Map Visibility & Layers */
        #map-canvas { height: 100%; width: 100%; background: #000; z-index: 1; }
        .leaflet-container { background: #000 !important; }
        
        /* High-Contrast Control UI */
        .map-ui-container { position: absolute; z-index: 2000; pointer-events: none; inset: 0; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; }
        .ui-top { display: flex; justify-content: space-between; width: 100%; pointer-events: none; }
        .ctrl-btn { pointer-events: auto; background: #ffffff !important; color: #000 !important; border: 2px solid var(--accent); padding: 14px 22px; border-radius: 16px; font-weight: 900; font-size: 11px; text-transform: uppercase; box-shadow: 0 10px 25px rgba(0,0,0,0.8); transition: transform 0.1s; }
        .ctrl-btn:active { transform: scale(0.92); }

        .page { display: none; width: 100vw; height: calc(100vh - 85px); flex-direction: column; overflow-y: auto; scroll-behavior: smooth; }
        .active-page { display: flex; }
        
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 85px; background: #000; display: grid; grid-template-columns: repeat(4, 1fr); border-top: 1px solid #1a1a1a; z-index: 5000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.3; font-size: 11px; font-weight: 800; color: white; border: none; background: none; transition: 0.2s; }
        .nav-btn-active { opacity: 1; color: var(--accent); border-top: 3px solid var(--accent); }

        /* Dashboard Typography */
        #timer-display { font-size: 30vw; font-weight: 800; color: #1a1a1c; line-height: 0.9; letter-spacing: -5px; }
        .status-pill { background: #111; border: 1px solid #222; padding: 6px 12px; border-radius: 8px; font-size: 10px; font-weight: bold; }
        
        /* Animations */
        @keyframes pulse-stabilizing { 0% { opacity: 0.4; } 50% { opacity: 1; color: #fff; } 100% { opacity: 0.4; } }
        .stabilizing { animation: pulse-stabilizing 1.5s infinite; }
    </style>
</head>
<body>

    <div id="page-dash" class="page active-page p-6">
        <div class="flex flex-col gap-4 mb-8">
            <div class="flex justify-between items-center">
                <span class="text-[10px] font-black tracking-widest opacity-40 uppercase">Satellite Link: <span id="gps-status" class="text-green-500">ACTIVE</span></span>
                <div id="stab-indicator" class="status-pill text-zinc-500 uppercase">Data Stabilization: <span id="stab-val" class="">WAITING</span></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-zinc-900/50 p-5 rounded-3xl border border-zinc-800">
                    <span class="text-[10px] opacity-30 uppercase block font-bold mb-1">Confidence</span>
                    <span id="conf-percent" class="text-2xl font-black text-white">0%</span>
                </div>
                <div class="bg-zinc-900/50 p-5 rounded-3xl border border-zinc-800 text-right">
                    <span class="text-[10px] opacity-30 uppercase block font-bold mb-1">Speed</span>
                    <span id="speed-val" class="text-2xl font-black text-white italic">0.0</span>
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col justify-center items-center">
            <div id="timer-display">0.0</div>
            <div id="engine-status" class="text-[10px] mt-4 font-black uppercase tracking-[0.3em] text-zinc-600">Standby Mode</div>
            <button id="master-switch" onclick="toggleEngine()" class="mt-12 w-full py-7 bg-zinc-900 text-zinc-500 font-black rounded-[32px] uppercase text-sm border-2 border-zinc-800 transition-all">Start Recon Engine</button>
        </div>
    </div>

    <div id="page-map" class="page" style="padding:0; overflow:hidden; position:relative;">
        <div id="map-canvas"></div>
        <div class="map-ui-container">
            <div class="ui-top">
                <button onclick="recenterMap()" class="ctrl-btn">â—Ž Recenter</button>
                <button onclick="toggleHeat()" id="heat-toggle" class="ctrl-btn" style="border-color: #333;">Heat: OFF</button>
            </div>
        </div>
    </div>
    
    <div id="page-history" class="page p-6">
        <div class="flex justify-between items-end mb-8">
            <h2 class="text-2xl font-black text-white uppercase italic">Archives</h2>
            <button onclick="enterSelectMode()" id="sel-btn" class="text-[10px] font-bold border border-zinc-700 px-4 py-2 rounded-full">SELECT</button>
        </div>
        <div id="multi-tools" class="hidden mb-6 bg-cyan-500 p-4 rounded-3xl flex justify-between items-center shadow-lg shadow-cyan-500/20">
            <span id="sel-count" class="text-black font-black text-xs">0 ITEMS</span>
            <button onclick="bulkDelete()" class="bg-black text-white text-[10px] font-black px-6 py-2 rounded-2xl">PURGE</button>
        </div>
        <div id="log-anchor" class="space-y-3 pb-32"></div>
    </div>

    <div id="page-sys" class="page p-8">
        <h2 class="text-white font-black text-xl uppercase mb-8">Terminal Settings</h2>
        <div class="space-y-4">
            <div class="bg-zinc-900/50 p-6 rounded-[32px] border border-zinc-800">
                <label class="text-[10px] font-black uppercase text-zinc-500 mb-4 block">Data Export</label>
                <button onclick="downloadCSV()" class="w-full bg-white text-black py-4 rounded-2xl font-black text-xs uppercase mb-2">Generate CSV Manifest</button>
                <div class="text-[9px] text-zinc-600 mt-2 italic">Stored locally in device browser.</div>
            </div>
            <div class="bg-zinc-900/50 p-6 rounded-[32px] border border-zinc-800">
                <label class="text-[10px] font-black uppercase text-zinc-500 mb-2 block">System Integrity</label>
                <div class="text-white text-xs font-bold">V17.5-PRO-MASTER</div>
                <div class="text-[10px] text-zinc-600 mt-1">Satellite Precision: High</div>
            </div>
        </div>
    </div>

    <div id="edit-view" class="modal">
        <div class="bg-zinc-900 w-full max-w-sm rounded-[40px] p-8 border border-zinc-800">
            <h3 class="text-white font-black text-sm mb-6 uppercase tracking-widest">Entry Options</h3>
            <select id="entry-cat" class="w-full bg-black p-5 rounded-2xl border border-zinc-800 text-white font-bold mb-8 outline-none focus:border-cyan-500">
                <option value="General">Normal Stop</option>
                <option value="Traffic">Traffic Delay</option>
                <option value="SafeZone">Safe Zone</option>
            </select>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="trashEntry()" class="bg-red-500/10 text-red-500 py-5 rounded-2xl font-black text-[10px] uppercase">Discard</button>
                <button onclick="applyEntry()" class="bg-cyan-500 text-black py-5 rounded-2xl font-black text-[10px] uppercase">Update</button>
            </div>
            <button onclick="hideModal()" class="w-full mt-8 text-[10px] font-bold opacity-30 uppercase">Close</button>
        </div>
    </div>

    <nav class="nav-bar">
        <button onclick="tab('dash')" id="tab-dash" class="nav-btn nav-btn-active">DASH</button>
        <button onclick="tab('map')" id="tab-map" class="nav-btn">MAP</button>
        <button onclick="tab('history')" id="tab-history" class="nav-btn">LOGS</button>
        <button onclick="tab('sys')" id="tab-sys" class="nav-btn">SYS</button>
    </nav>

    <script>
        const STORAGE_ID = 'GRV_INTEL_MASTER_V17';
        let data = JSON.parse(localStorage.getItem(STORAGE_ID) || '[]');
        let active = false, timing = false, startTime = 0, clock = null;
        let map, userPointer, trail, heat, logs = L.layerGroup();
        let currentPos = { lat: 0, lon: 0, acc: 0 };
        let activeID = null, heatON = false, selectionMode = false;
        let selectedSet = new Set();

        // Engine Control
        function toggleEngine() {
            active = !active;
            const b = document.getElementById('master-switch');
            const s = document.getElementById('engine-status');
            b.innerText = active ? "ENGINE RUNNING" : "START RECON ENGINE";
            b.style.borderColor = active ? "#00f2ff" : "#27272a";
            b.style.color = active ? "#fff" : "#71717a";
            s.innerText = active ? "Monitoring Signals..." : "Standby Mode";
            if(!active) killTimer();
        }

        function runTimer() {
            if (timing || !active) return;
            timing = true; startTime = Date.now();
            clock = setInterval(() => {
                const dur = (Date.now() - startTime) / 1000;
                document.getElementById('timer-display').innerText = dur.toFixed(1);
                paintTimer(dur);
            }, 100);
        }

        function killTimer() {
            if (!timing) return;
            timing = false; clearInterval(clock);
            const final = parseFloat(((Date.now() - startTime) / 1000).toFixed(1));
            if (final > 2.5) {
                data.push({ id: Date.now(), d: final, ts: Date.now(), lat: currentPos.lat, lon: currentPos.lon, cat: "General" });
                save();
            }
            document.getElementById('timer-display').innerText = "0.0";
            document.getElementById('timer-display').style.color = "#1a1a1c";
        }

        function paintTimer(s) {
            const v = data.filter(x => x.cat !== 'SafeZone');
            const d = document.getElementById('timer-display');
            if (v.length < 4) return;
            const a = v.reduce((p, c) => p + c.d, 0) / v.length;
            d.style.color = s <= a * 0.8 ? "#22c55e" : (s <= a * 1.2 ? "#eab308" : "#ef4444");
        }

        // Map Engine
        function bootMap() {
            if (map) return;
            map = L.map('map-canvas', { zoomControl: false, attributionControl: false }).setView([currentPos.lat, currentPos.lon], 16);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            logs.addTo(map);
            userPointer = L.circleMarker([currentPos.lat, currentPos.lon], { radius: 10, color: '#fff', weight: 3, fillColor: '#00f2ff', fillOpacity: 1 }).addTo(map);
            syncMap();
        }

        function recenterMap() { if (currentPos.lat !== 0) map.flyTo([currentPos.lat, currentPos.lon], 17); }

        function toggleHeat() {
            heatON = !heatON;
            const b = document.getElementById('heat-toggle');
            b.innerText = heatON ? "Heat: ON" : "Heat: OFF";
            b.style.borderColor = heatON ? "#f97316" : "#333";
            syncMap();
        }

        function syncMap() {
            if(!logs) return;
            logs.clearLayers();
            if(heat) map.removeLayer(heat);
            if(trail) map.removeLayer(trail);

            // 24H History Trail
            const cut = Date.now() - 86400000;
            const pts = data.filter(x => x.ts > cut).sort((a,b) => a.ts - b.ts).map(x => [x.lat, x.lon]);
            if(pts.length > 1) trail = L.polyline(pts, { color: '#00f2ff', weight: 2, opacity: 0.2, dashArray: '4, 8' }).addTo(map);

            if (heatON) {
                heat = L.heatLayer(data.map(x => [x.lat, x.lon, 0.4]), { radius: 20, blur: 15 }).addTo(map);
            } else {
                data.forEach(item => {
                    L.circleMarker([item.lat, item.lon], { 
                        radius: 7, 
                        color: item.cat === "SafeZone" ? "#a855f7" : "#00f2ff", 
                        fillColor: item.cat === "SafeZone" ? "#a855f7" : "#00f2ff", 
                        fillOpacity: 0.5 
                    }).addTo(logs).on('click', () => showEdit(item));
                });
            }
        }

        // Location Logic
        navigator.geolocation.watchPosition(p => {
            currentPos = { lat: p.coords.latitude, lon: p.coords.longitude, acc: p.coords.accuracy };
            const speed = (p.coords.speed || 0) * 3.6;
            document.getElementById('speed-val').innerText = speed.toFixed(1);
            
            // User-requested Data Stabilization logic
            const stabBox = document.getElementById('stab-val');
            if (p.coords.accuracy < 15) {
                stabBox.innerText = "STABLE";
                stabBox.className = "text-green-500 font-bold";
            } else {
                stabBox.innerText = "STABILIZING...";
                stabBox.className = "text-yellow-500 stabilizing";
            }

            if (active && speed < 1.2 && !timing) runTimer();
            if (timing && speed > 6.0) killTimer();
            if (userPointer) userPointer.setLatLng([currentPos.lat, currentPos.lon]);
        }, e => {
            document.getElementById('gps-status').innerText = "ERROR";
            document.getElementById('gps-status').className = "text-red-500";
        }, { enableHighAccuracy: true });

        // Storage & UI Utils
        function save() {
            localStorage.setItem(STORAGE_ID, JSON.stringify(data));
            const v = data.filter(x => x.cat !== 'SafeZone');
            document.getElementById('conf-percent').innerText = Math.min((v.length / 4) * 100, 100).toFixed(0) + "%";
            if(map) syncMap();
        }

        function renderList() {
            const h = document.getElementById('log-anchor');
            h.innerHTML = "";
            [...data].reverse().forEach(x => {
                const s = selectedSet.has(x.id);
                const d = document.createElement('div');
                d.className = `bg-zinc-900/40 p-5 rounded-3xl flex justify-between items-center border ${s ? 'border-cyan-500 bg-cyan-500/5' : 'border-zinc-800'}`;
                d.onclick = () => {
                    if(selectionMode) {
                        if(s) selectedSet.delete(x.id); else selectedSet.add(x.id);
                        document.getElementById('sel-count').innerText = `${selectedSet.size} ITEMS`;
                        renderList();
                    } else { showEdit(x); }
                };
                d.innerHTML = `<div><div class="text-white font-black text-lg">${x.d}s</div><div class="text-[9px] opacity-30 font-bold uppercase">${new Date(x.ts).toLocaleTimeString()}</div></div><div class="text-[9px] font-black uppercase ${x.cat === 'SafeZone' ? 'text-purple-500' : 'text-cyan-500'}">${x.cat}</div>`;
                h.appendChild(d);
            });
        }

        function tab(n) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-btn-active'));
            document.getElementById('page-'+n).classList.add('active-page');
            document.getElementById('tab-'+n).classList.add('nav-btn-active');
            if(n === 'map') { bootMap(); setTimeout(() => map.invalidateSize(), 300); }
            if(n === 'history') renderList();
        }

        function showEdit(i) { activeID = i.id; document.getElementById('entry-cat').value = i.cat; document.getElementById('edit-view').classList.add('active'); }
        function hideModal() { document.getElementById('edit-view').classList.remove('active'); }
        function applyEntry() {
            const i = data.findIndex(x => x.id === activeID);
            if(i !== -1) { data[i].cat = document.getElementById('entry-cat').value; save(); }
            hideModal();
        }
        function trashEntry() { data = data.filter(x => x.id !== activeID); save(); hideModal(); renderList(); }
        function enterSelectMode() { selectionMode = !selectionMode; selectedSet.clear(); document.getElementById('sel-btn').innerText = selectionMode ? "CANCEL" : "SELECT"; document.getElementById('multi-tools').classList.toggle('hidden', !selectionMode); renderList(); }
        function bulkDelete() { if(confirm("Purge selected data?")) { data = data.filter(x => !selectedSet.has(x.id)); save(); enterSelectMode(); renderList(); } }
        function downloadCSV() {
            const h = ["ID", "Duration", "Timestamp", "Latitude", "Longitude", "Category"];
            const r = data.map(x => [x.id, x.d, new Date(x.ts).toISOString(), x.lat, x.lon, x.cat].join(","));
            const blob = new Blob([[h.join(","), ...r].join("\n")], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `recon_data_${Date.now()}.csv`; a.click();
        }

        save(); // Initial state sync
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gravity Intel V5.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        :root { --accent: #00f2ff; --bg: #000; }
        body { font-family: 'JetBrains+Mono', monospace; background: var(--bg); color: var(--accent); margin: 0; overflow: hidden; height: 100vh; }
        
        /* PAGE LAYOUT */
        .page { display: none; height: calc(100vh - 100px); width: 100vw; flex-direction: column; padding: 20px; overflow-y: auto; box-sizing: border-box; }
        .active-page { display: flex; }
        
        /* BOTTOM TACTICAL NAVIGATION - THE FIX */
        .nav-bar { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 80px; 
            background: #0a0a0a; border-top: 2px solid #1a1a1a; 
            display: grid; grid-template-columns: repeat(4, 1fr); 
            z-index: 9999; 
        }
        .nav-btn { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-right: 1px solid #1a1a1a; transition: 0.2s;
        }
        .nav-btn:last-child { border-right: none; }
        .nav-btn span { font-size: 10px; font-weight: 800; opacity: 0.4; letter-spacing: 1px; }
        .nav-btn-active { background: #001a1a; }
        .nav-btn-active span { opacity: 1; color: var(--accent); }
        .nav-btn-active .icon-box { border-color: var(--accent); background: var(--accent); }

        .icon-box { width: 12px; height: 4px; border: 1px solid #333; margin-bottom: 6px; transition: 0.2s; }

        /* HEADER */
        .system-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: #050505; border-bottom: 1px solid #111; }
        
        #timer-display { font-size: 28vw; font-weight: 800; line-height: 1; }
        #map-canvas { height: 100%; width: 100%; border-radius: 8px; border: 1px solid #222; }
        .leaflet-tile-container { filter: invert(100%) hue-rotate(180deg) brightness(85%); }
    </style>
</head>
<body>

    <div class="system-header">
        <div class="flex items-center gap-3">
            <div id="gps-indicator" class="w-2 h-2 rounded-full bg-zinc-800"></div>
            <span id="gps-text" class="text-[9px] font-black uppercase opacity-40">GPS_OFFLINE</span>
        </div>
        <div id="accuracy-box" class="text-[9px] font-bold opacity-60 uppercase">Acc: --</div>
    </div>

    <div id="page-dash" class="page active-page items-center justify-center">
        <div id="timer-display">0.0</div>
        <div id="velocity-out" class="text-[10px] opacity-40 mb-10 tracking-[0.4em]">SPEED: 0.0 M/S</div>
        <button id="arm-btn" class="border-2 border-cyan-400 px-12 py-5 rounded-full font-black uppercase text-xs active:bg-cyan-400 active:text-black">Arm System</button>
    </div>

    <div id="page-map" class="page">
        <h2 class="text-[10px] font-black uppercase mb-3 tracking-widest">Global_Stops_Map</h2>
        <div id="map-canvas"></div>
    </div>

    <div id="page-history" class="page">
        <h2 class="text-[10px] font-black uppercase mb-4 tracking-widest">Recent_Activity</h2>
        <div id="history-list" class="space-y-2"></div>
    </div>

    <div id="page-leader" class="page">
        <h2 class="text-[10px] font-black uppercase mb-4 tracking-widest">Top_Latency_Scores</h2>
        <div id="leader-list" class="space-y-3"></div>
        <button onclick="clearAllData()" class="mt-10 opacity-20 text-[8px] uppercase border border-red-900 p-2">Clear Data</button>
    </div>

    <nav class="nav-bar">
        <button onclick="showPage('dash')" class="nav-btn nav-btn-active" id="btn-dash">
            <div class="icon-box"></div><span>DASH</span>
        </button>
        <button onclick="showPage('map')" class="nav-btn" id="btn-map">
            <div class="icon-box"></div><span>MAP</span>
        </button>
        <button onclick="showPage('history')" class="nav-btn" id="btn-history">
            <div class="icon-box"></div><span>LOGS</span>
        </button>
        <button onclick="showPage('leader')" class="nav-btn" id="btn-leader">
            <div class="icon-box"></div><span>RANK</span>
        </button>
    </nav>

    <script>
        // Logic remains the same as V5.1 for accuracy and speed
        let db = JSON.parse(localStorage.getItem('gravity_final_db') || '[]');
        let isArmed = false, isIdling = false, startTime, timerInterval, gpsWatch, mapObj = null;
        let lastPos = { lat: 0, lng: 0 };

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-btn-active'));
            
            document.getElementById(`page-${pageId}`).classList.add('active-page');
            document.getElementById(`btn-${pageId}`).classList.add('nav-btn-active');

            if(pageId === 'map') initMap();
            if(pageId === 'history') renderHistory();
            if(pageId === 'leader') renderLeaderboard();
        }

        // Logic processing (Hysteresis-protected)
        function processLogic(pos) {
            const spd = pos.coords.speed || 0;
            const acc = pos.coords.accuracy || 0;
            lastPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };

            document.getElementById('velocity-out').innerText = `SPEED: ${spd.toFixed(1)} M/S`;
            document.getElementById('accuracy-box').innerText = `ACC: ${acc.toFixed(0)}M`;
            
            if(acc < 30) {
                document.getElementById('gps-indicator').className = "w-2 h-2 rounded-full bg-cyan-400 shadow-[0_0_10px_#00f2ff]";
                document.getElementById('gps-text').innerText = "GPS_LOCKED";
            }

            if (isArmed && spd <= 0.5 && !isIdling) {
                isIdling = true;
                startTime = Date.now();
                document.getElementById('timer-display').classList.add('text-red-500');
                timerInterval = setInterval(() => {
                    document.getElementById('timer-display').innerText = ((Date.now() - startTime) / 1000).toFixed(1);
                }, 100);
            } else if (isIdling && spd > 1.1) {
                isIdling = false;
                clearInterval(timerInterval);
                document.getElementById('timer-display').classList.remove('text-red-500');
                const dur = parseFloat(document.getElementById('timer-display').innerText);
                if(dur > 2) {
                    db.push({ ts: Date.now(), dur, lat: lastPos.lat, lng: lastPos.lng });
                    localStorage.setItem('gravity_final_db', JSON.stringify(db));
                }
                document.getElementById('timer-display').innerText = "0.0";
            }
        }

        document.getElementById('arm-btn').addEventListener('click', function() {
            isArmed = !isArmed;
            this.style.background = isArmed ? "var(--accent)" : "transparent";
            this.style.color = isArmed ? "#000" : "var(--accent)";
            if (isArmed) {
                gpsWatch = navigator.geolocation.watchPosition(processLogic, null, { enableHighAccuracy: true });
            } else {
                navigator.geolocation.clearWatch(gpsWatch);
            }
        });

        function initMap() {
            setTimeout(() => {
                if(mapObj) mapObj.remove();
                mapObj = L.map('map-canvas', { zoomControl: false }).setView([lastPos.lat, lastPos.lng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapObj);
                db.forEach(e => L.circle([e.lat, e.lng], { color: 'cyan', radius: 15 }).addTo(mapObj));
            }, 100);
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = db.slice(-10).reverse().map(e => `
                <div class="p-4 border-b border-zinc-900 flex justify-between">
                    <span class="font-bold">${e.dur}s</span>
                    <span class="opacity-30 text-[8px]">${new Date(e.ts).toLocaleTimeString()}</span>
                </div>
            `).join('');
        }

        function renderLeaderboard() {
            const list = document.getElementById('leader-list');
            const sorted = [...db].sort((a,b) => b.dur - a.dur).slice(0, 5);
            list.innerHTML = sorted.map((e, i) => `
                <div class="p-4 bg-zinc-900 border-l-2 border-cyan-400 flex justify-between">
                    <div><p class="text-[7px] opacity-40">RANK #0${i+1}</p><p class="text-lg font-black">${e.dur}s</p></div>
                </div>
            `).join('');
        }

        function clearAllData() { if(confirm("Wipe logs?")) { db = []; localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gravity Intel V17.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        :root { --accent: #00f2ff; --bg: #0a0a0a; }
        body { font-family: 'JetBrains Mono', monospace; background: var(--bg); color: var(--accent); margin: 0; overflow: hidden; height: 100vh; font-size: 16px; }
        
        /* FIX: Map Visibility */
        #map-canvas { height: 100%; width: 100%; background: #111; z-index: 1; }
        .leaflet-container { background: #111 !important; }

        /* High Visibility Overlay Buttons */
        .map-overlay-btn {
            background: #ffffff !important;
            color: #000000 !important;
            border: 2px solid var(--accent);
            padding: 12px 18px;
            border-radius: 14px;
            font-weight: 900;
            font-size: 11px;
            text-transform: uppercase;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            pointer-events: auto;
        }

        .page { display: none; width: 100vw; height: calc(100vh - 85px); flex-direction: column; overflow-y: auto; }
        .active-page { display: flex; }
        
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 85px; background: #000; display: grid; grid-template-columns: repeat(4, 1fr); border-top: 1px solid #222; z-index: 5000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.4; font-size: 12px; font-weight: 700; color: white; border: none; background: none; }
        .nav-btn-active { opacity: 1; color: var(--accent); border-top: 3px solid var(--accent); }

        #timer-display { font-size: 28vw; font-weight: 700; color: #27272a; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
    </style>
</head>
<body>

    <div id="page-dash" class="page active-page p-6">
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-zinc-900 p-4 rounded-2xl border border-zinc-800">
                <span class="text-[10px] opacity-40 uppercase block">Stability</span>
                <span id="stab-percent" class="text-lg font-bold">0%</span>
            </div>
            <div class="bg-zinc-900 p-4 rounded-2xl border border-zinc-800 text-right">
                <span class="text-[10px] opacity-40 uppercase block">Velocity</span>
                <span id="speed-display" class="text-lg font-bold text-white">0.0 KM/H</span>
            </div>
        </div>
        <div class="flex-1 flex flex-col justify-center items-center">
            <div id="timer-display">0.0</div>
            <div id="data-status" class="text-xs mt-4 opacity-50 font-bold uppercase tracking-widest">Awaiting Engine</div>
            <button id="btn-master" onclick="toggleSystem()" class="mt-12 w-full py-6 bg-zinc-800 text-zinc-400 font-black rounded-3xl uppercase text-lg shadow-xl">Initiate Engine</button>
        </div>
    </div>

    <div id="page-map" class="page" style="padding:0; overflow:hidden; position:relative;">
        <div id="map-canvas"></div>
        
        <div class="absolute top-6 left-6 right-6 flex justify-between items-start z-[2000] pointer-events-none">
            <button onclick="recenterMap()" class="map-overlay-btn">â—Ž Find Me</button>
            <button onclick="toggleHeatmap()" id="heat-btn" class="map-overlay-btn" style="border-color: #71717a;">Heatmap: OFF</button>
        </div>
    </div>
    
    <div id="page-history" class="page p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-white font-black text-xl uppercase">Geospatial Logs</h2>
            <button id="edit-mode-btn" onclick="toggleEditMode()" class="text-[10px] font-bold border border-zinc-700 px-3 py-2 rounded-xl text-zinc-400">SELECT</button>
        </div>
        <div id="bulk-actions" class="hidden mb-4 bg-zinc-900 p-4 rounded-2xl flex justify-between items-center border border-cyan-500/30">
            <span id="selected-count" class="text-xs font-bold text-cyan-500">0 SELECTED</span>
            <button onclick="deleteSelected()" class="bg-red-500 text-white text-[10px] font-black px-4 py-2 rounded-xl uppercase">Delete Group</button>
        </div>
        <div id="history-list" class="space-y-3 pb-32"></div>
    </div>

    <div id="page-about" class="page p-6">
        <h2 class="text-white font-black text-xl uppercase mb-6">System</h2>
        <div class="bg-zinc-900 p-6 rounded-[32px] border border-zinc-800 mb-4">
            <button onclick="exportToCSV()" class="w-full bg-cyan-500 text-black py-4 rounded-2xl font-black text-xs uppercase mb-3">Export Records (CSV)</button>
            <p class="text-[10px] text-zinc-500">Total Records: <span id="record-count-stat" class="text-zinc-300">0</span></p>
        </div>
        <div class="bg-zinc-900 p-6 rounded-[32px] border border-zinc-800 text-[10px] text-zinc-500">
            BUILD: V17.5 / NATIVE_MAP_ENGINE
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="bg-zinc-900 w-full max-w-sm rounded-[32px] p-8 border border-zinc-800">
            <h3 class="text-white font-black text-lg mb-6 uppercase">Modify Record</h3>
            <select id="edit-category" class="w-full bg-black p-4 rounded-xl border border-zinc-700 text-white font-bold mb-8">
                <option value="General">Standard Stop</option>
                <option value="SafeZone">Safe Zone</option>
            </select>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="deleteCurrentRecord()" class="bg-red-500/10 text-red-500 py-4 rounded-xl font-black text-xs uppercase">Delete</button>
                <button onclick="saveEdit()" class="bg-cyan-500 text-black py-4 rounded-xl font-black text-xs uppercase">Save</button>
            </div>
            <button onclick="closeModal()" class="w-full mt-6 text-[10px] font-bold opacity-30 uppercase">Cancel</button>
        </div>
    </div>

    <nav class="nav-bar">
        <button onclick="tab('dash')" id="tab-dash" class="nav-btn nav-btn-active">DASH</button>
        <button onclick="tab('map')" id="tab-map" class="nav-btn">MAP</button>
        <button onclick="tab('history')" id="tab-history" class="nav-btn">LOGS</button>
        <button onclick="tab('about')" id="tab-about" class="nav-btn">SYS</button>
    </nav>

    <script>
        const DB_KEY = 'GRV_V16_MASTER';
        const STABILITY_THRESHOLD = 4;
        let storage = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
        let isArmed = false, isStopped = false, startMark = 0, timerInterval = null;
        let map, userMarker, historyGroup, heatLayer, ghostRoute = null;
        let lastCoords = { lat: 0, lon: 0 };
        let activeRecordId = null, heatActive = false, isEditMode = false;
        let selectedIds = new Set();

        function toggleSystem() {
            isArmed = !isArmed;
            const btn = document.getElementById('btn-master');
            btn.innerText = isArmed ? "ENGINE ACTIVE" : "INITIATE ENGINE";
            btn.style.backgroundColor = isArmed ? "#00f2ff" : "#27272a";
            btn.style.color = isArmed ? "#000" : "#71717a";
            if(!isArmed) stopTimer();
        }

        function startTimer() {
            if (isStopped || !isArmed) return;
            isStopped = true; startMark = Date.now();
            timerInterval = setInterval(() => {
                const sec = (Date.now() - startMark) / 1000;
                document.getElementById('timer-display').innerText = sec.toFixed(1);
                updateTimerColor(sec);
            }, 100);
        }

        function stopTimer() {
            if (!isStopped) return;
            isStopped = false; clearInterval(timerInterval);
            const duration = parseFloat(((Date.now() - startMark) / 1000).toFixed(1));
            if (duration > 3) {
                storage.push({ id: Date.now(), d: duration, ts: Date.now(), lat: lastCoords.lat, lon: lastCoords.lon, cat: "General" });
                localStorage.setItem(DB_KEY, JSON.stringify(storage));
                updateDashboard();
            }
            document.getElementById('timer-display').innerText = "0.0";
            document.getElementById('timer-display').style.color = "#27272a";
        }

        function updateTimerColor(sec) {
            const valid = storage.filter(i => i.cat !== 'SafeZone');
            const display = document.getElementById('timer-display');
            if (valid.length < STABILITY_THRESHOLD) return;
            const avg = valid.reduce((a, b) => a + b.d, 0) / valid.length;
            display.style.color = sec <= avg * 0.8 ? "#22c55e" : (sec <= avg * 1.2 ? "#f59e0b" : "#ef4444");
        }

        function initMap() {
            if (map) return;
            map = L.map('map-canvas', { zoomControl: false, attributionControl: false }).setView([lastCoords.lat, lastCoords.lon], 16);
            
            // Native Dark Tiles (No CSS Filters)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

            historyGroup = L.layerGroup().addTo(map);
            userMarker = L.circleMarker([lastCoords.lat, lastCoords.lon], { 
                radius: 12, color: '#fff', weight: 3, fillColor: '#00f2ff', fillOpacity: 1 
            }).addTo(map);
            
            renderMapData();
        }

        function recenterMap() {
            if (lastCoords.lat !== 0) map.flyTo([lastCoords.lat, lastCoords.lon], 17);
        }

        function toggleHeatmap() {
            heatActive = !heatActive;
            const btn = document.getElementById('heat-btn');
            btn.innerText = heatActive ? "Heatmap: ON" : "Heatmap: OFF";
            btn.style.borderColor = heatActive ? "#f97316" : "#71717a";
            btn.style.color = heatActive ? "#f97316" : "#000";
            renderMapData();
        }

        function renderMapData() {
            if(!historyGroup) return;
            historyGroup.clearLayers();
            if(heatLayer) map.removeLayer(heatLayer);
            if(ghostRoute) map.removeLayer(ghostRoute);

            // Ghost Route (24h)
            const dayAgo = Date.now() - 86400000;
            const recent = storage.filter(i => i.ts > dayAgo).sort((a,b) => a.ts - b.ts).map(i => [i.lat, i.lon]);
            if(recent.length > 1) ghostRoute = L.polyline(recent, { color: '#00f2ff', weight: 2, opacity: 0.3, dashArray: '5, 10' }).addTo(map);

            if (heatActive) {
                heatLayer = L.heatLayer(storage.map(i => [i.lat, i.lon, 0.5]), { radius: 25, blur: 15 }).addTo(map);
            } else {
                storage.forEach(item => {
                    L.circleMarker([item.lat, item.lon], { 
                        radius: 8, color: item.cat === "SafeZone" ? "#a855f7" : "#00f2ff", fillColor: item.cat === "SafeZone" ? "#a855f7" : "#00f2ff", fillOpacity: 0.6 
                    }).addTo(historyGroup).on('click', () => { activeRecordId = item.id; openEditModal(item); });
                });
            }
        }

        function renderLogs() {
            const list = document.getElementById('history-list');
            list.innerHTML = "";
            [...storage].reverse().forEach(i => {
                const isSel = selectedIds.has(i.id);
                const div = document.createElement('div');
                div.className = `bg-zinc-900 p-5 rounded-2xl flex justify-between items-center border ${isSel ? 'border-cyan-500' : 'border-zinc-800'}`;
                div.onclick = () => {
                    if(isEditMode) {
                        if(isSel) selectedIds.delete(i.id); else selectedIds.add(i.id);
                        document.getElementById('selected-count').innerText = `${selectedIds.size} SELECTED`;
                        renderLogs();
                    } else { activeRecordId = i.id; openEditModal(i); }
                };
                div.innerHTML = `<div><div class="text-white font-bold">${i.d}s</div><div class="text-[10px] opacity-30">${new Date(i.ts).toLocaleTimeString()}</div></div><div class="text-[10px] font-bold ${i.cat === 'SafeZone' ? 'text-purple-500' : 'text-cyan-500'} uppercase">${i.cat}</div>`;
                list.appendChild(div);
            });
        }

        function tab(n) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-btn-active'));
            document.getElementById('page-'+n).classList.add('active-page');
            document.getElementById('tab-'+n).classList.add('nav-btn-active');
            if(n === 'map') { initMap(); setTimeout(() => map.invalidateSize(), 250); }
            if(n === 'history') renderLogs();
        }

        navigator.geolocation.watchPosition(pos => {
            lastCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            const speed = (pos.coords.speed || 0) * 3.6;
            document.getElementById('speed-display').innerText = speed.toFixed(1) + " KM/H";
            if (isArmed && speed < 1.0 && !isStopped) startTimer();
            if (isStopped && speed > 5.0) stopTimer();
            if (userMarker) userMarker.setLatLng([lastCoords.lat, lastCoords.lon]);
        }, null, { enableHighAccuracy: true });

        function updateDashboard() {
            const valid = storage.filter(i => i.cat !== 'SafeZone');
            document.getElementById('stab-percent').innerText = Math.min((valid.length / STABILITY_THRESHOLD) * 100, 100).toFixed(0) + "%";
            document.getElementById('record-count-stat').innerText = storage.length;
        }

        function openEditModal(i) { document.getElementById('edit-category').value = i.cat; document.getElementById('edit-modal').classList.add('active'); }
        function closeModal() { document.getElementById('edit-modal').classList.remove('active'); }
        function saveEdit() { 
            const idx = storage.findIndex(i => i.id === activeRecordId);
            if(idx !== -1) { storage[idx].cat = document.getElementById('edit-category').value; localStorage.setItem(DB_KEY, JSON.stringify(storage)); updateDashboard(); }
            closeModal();
        }
        function deleteCurrentRecord() { storage = storage.filter(i => i.id !== activeRecordId); localStorage.setItem(DB_KEY, JSON.stringify(storage)); updateDashboard(); closeModal(); }
        function toggleEditMode() { isEditMode = !isEditMode; selectedIds.clear(); document.getElementById('edit-mode-btn').innerText = isEditMode ? "CANCEL" : "SELECT"; document.getElementById('bulk-actions').classList.toggle('hidden', !isEditMode); renderLogs(); }
        function deleteSelected() { if(confirm("Delete selection?")) { storage = storage.filter(i => !selectedIds.has(i.id)); localStorage.setItem(DB_KEY, JSON.stringify(storage)); toggleEditMode(); updateDashboard(); } }
        function exportToCSV() {
            const rows = [["ID", "Duration", "Time", "Lat", "Lon", "Cat"], ...storage.map(i => [i.id, i.d, new Date(i.ts).toISOString(), i.lat, i.lon, i.cat])];
            const url = URL.createObjectURL(new Blob([rows.map(r => r.join(",")).join("\n")], { type: 'text/csv' }));
            const a = document.createElement('a'); a.href = url; a.download = `gravity_${Date.now()}.csv`; a.click();
        }

        updateDashboard();
    </script>
</body>
</html>

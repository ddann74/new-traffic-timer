<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gravity Intelligence + Snapshot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        body { font-family: 'JetBrains+Mono', monospace; background-color: #050505; color: #10b981; overflow: hidden; }
        .page { display: none; height: 100vh; width: 100vw; position: absolute; padding: 20px; z-index: 10; }
        .active-page { display: flex; flex-direction: column; }
        .emerald-glow { text-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }
        #map, #snapshot-map { height: 400px; border-radius: 12px; filter: invert(100%) hue-rotate(180deg) brightness(95%); margin-top: 20px; }
        .btn-nav { border: 1px solid #10b981; padding: 10px; text-align: center; font-size: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="page-dash" class="page active-page">
        <div class="flex justify-between items-start mb-4">
            <button onclick="showPage('page-menu')" class="text-xs border border-emerald-500/30 px-3 py-1">MENU</button>
            <div class="text-right">
                <button onclick="takeSnapshot()" id="snap-btn" class="hidden text-[10px] bg-emerald-500 text-black px-2 py-1 font-bold rounded">SNAPSHOT</button>
                <p id="status-text" class="text-xs font-bold uppercase tracking-widest mt-2">Scanning_</p>
            </div>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center">
            <p id="prediction-msg" class="text-[10px] text-orange-500 h-4"></p>
            <div id="timer-display" class="text-[25vw] font-black tracking-tighter emerald-glow transition-colors duration-700">0.0</div>
            <button id="ignition-btn" class="mt-4 px-10 py-3 border-2 border-emerald-500 rounded-full font-bold text-xs tracking-widest uppercase">Arm System</button>
            <p id="speed-display" class="text-[10px] opacity-40 mt-4 uppercase tracking-[0.3em]">Spd: 0.0 m/s</p>
        </div>
    </div>

    <div id="page-snap" class="page bg-black/95">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-black italic text-emerald-500">SESSION_HEATMAP</h2>
            <button onclick="showPage('page-dash')" class="text-xs border border-white/20 px-4 py-2">CLOSE</button>
        </div>
        <p class="text-[10px] opacity-50 uppercase">Stops during this armed session:</p>
        <div id="snapshot-map"></div>
        <div class="mt-6 p-4 border border-emerald-500/20 rounded-lg">
            <p class="text-[10px] opacity-40 uppercase">Session Efficiency</p>
            <p id="snap-stats" class="text-xl font-bold italic">Analyzing...</p>
        </div>
    </div>

    <div id="page-menu" class="page">...</div>

    <script>
        let db = JSON.parse(localStorage.getItem('gravity_db') || '[]');
        let isArmed = false, isIdling = false, startTime, timerInterval, currentPos = null;
        let sessionStartTime = null; 
        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let snapMapInstance = null;

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById(id).classList.add('active-page');
        }

        function takeSnapshot() {
            showPage('page-snap');
            const sessionData = db.filter(log => log.ts >= sessionStartTime);
            
            if (snapMapInstance) snapMapInstance.remove();
            
            // Focus map on the first stop of the session or current pos
            const center = sessionData.length > 0 ? [sessionData[0].lat, sessionData[0].lng] : [currentPos.lat, currentPos.lng];
            snapMapInstance = L.map('snapshot-map').setView(center, 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(snapMapInstance);

            let totalDur = 0;
            sessionData.forEach(l => {
                totalDur += l.dur;
                // Heatmap effect: radius and color based on duration
                const color = l.dur > 60 ? '#ef4444' : (l.dur > 30 ? '#f97316' : '#10b981');
                L.circle([l.lat, l.lng], {
                    radius: 30 + (l.dur * 0.5), 
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.6
                }).addTo(snapMapInstance);
            });

            document.getElementById('snap-stats').innerText = `${sessionData.length} STOPS / ${Math.round(totalDur/60)}m WASTED`;
        }

        // Updated Ignition to track session start
        document.getElementById('ignition-btn').addEventListener('click', () => {
            isArmed = !isArmed;
            const btn = document.getElementById('ignition-btn');
            const snapBtn = document.getElementById('snap-btn');
            
            if (isArmed) {
                sessionStartTime = Date.now();
                btn.innerText = "SYSTEM ARMED";
                btn.classList.add('bg-emerald-500/10');
                snapBtn.classList.remove('hidden');
            } else {
                btn.innerText = "ARM SYSTEM";
                btn.classList.remove('bg-emerald-500/10');
                // Don't hide snapBtn immediately so they can see the drive map after they park
            }
        });

        // (Include previous startIdle, stopIdle, and geolocation logic here)
        // Ensure db.push includes coordinates and ts as before
    </script>
</body>
</html>

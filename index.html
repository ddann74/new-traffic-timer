<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gravity Intel Pro V4.7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        :root { --accent: #00f2ff; --bg: #050505; }
        body { font-family: 'JetBrains+Mono', monospace; background: var(--bg); color: var(--accent); margin: 0; overflow: hidden; }
        .system-bar { background: #000; border-bottom: 1px solid #111; padding: 12px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .status-pill { font-size: 8px; border: 1px solid #222; padding: 2px 8px; border-radius: 10px; text-transform: uppercase; }
        .gate-active { color: #fff; background: #c00; border-color: #f00; }
        #timer-display { font-size: 30vw; font-weight: 800; line-height: 1; transition: color 0.3s; }
        .recording { color: #ff4444; text-shadow: 0 0 30px rgba(255, 0, 0, 0.4); }
        .btn-main { border: 2px solid var(--accent); padding: 20px 50px; border-radius: 50px; font-weight: 800; text-transform: uppercase; }
        .btn-armed { background: var(--accent); color: #000; }
    </style>
</head>
<body>

    <div class="system-bar">
        <div class="flex flex-col">
            <span class="text-[9px] opacity-40">GPS_ACCURACY</span>
            <span id="accuracy-val" class="text-[10px] font-bold">--</span>
        </div>
        <div class="flex gap-2">
            <div id="gate-idle" class="status-pill">Moving</div>
            <div id="gate-stop" class="status-pill">Stopped</div>
        </div>
    </div>

    <div class="flex flex-col items-center justify-center h-[80vh]">
        <div id="timer-display">0.0</div>
        <div id="velocity-out" class="text-xs font-bold mt-4 opacity-60 uppercase tracking-widest">Speed: 0.00 M/S</div>
        
        <div class="mt-10 flex flex-col items-center gap-4">
            <button id="arm-btn" class="btn-main">Arm System</button>
            <button id="force-stop" class="hidden text-[10px] text-red-500 underline uppercase">Force Save & Stop</button>
        </div>

        <div class="mt-8 w-64 p-4 border border-zinc-900 rounded-lg">
            <p class="text-[8px] uppercase mb-2 opacity-50 text-center">Sensitivity (Stop at speed < X)</p>
            <input type="range" id="sense-slider" min="0.1" max="1.5" step="0.1" value="0.5" class="w-full accent-cyan-400">
            <div class="flex justify-between text-[8px] mt-1 opacity-40"><span>STRICT (0.1)</span><span>LOOSE (1.5)</span></div>
        </div>
    </div>

    <script>
        let isArmed = false, isIdling = false, startTime, timerInterval, gpsWatch;
        let stopThreshold = 0.5;

        const timerEl = document.getElementById('timer-display');
        const gateIdle = document.getElementById('gate-idle');
        const gateStop = document.getElementById('gate-stop');
        const forceBtn = document.getElementById('force-stop');

        function processLogic(pos) {
            const spd = pos.coords.speed || 0;
            const acc = pos.coords.accuracy || 0;
            
            document.getElementById('velocity-out').innerText = `Speed: ${spd.toFixed(2)} M/S`;
            document.getElementById('accuracy-val').innerText = `${acc.toFixed(1)}M`;

            if (!isArmed) return;

            // TIMER START LOGIC (Speed drops below threshold)
            if (spd <= stopThreshold && !isIdling) {
                isIdling = true;
                startTime = Date.now();
                timerEl.classList.add('recording');
                gateStop.classList.add('gate-active');
                gateIdle.classList.remove('gate-active');
                forceBtn.classList.remove('hidden');
                
                timerInterval = setInterval(() => {
                    timerEl.innerText = ((Date.now() - startTime) / 1000).toFixed(1);
                }, 100);
            } 
            
            // TIMER STOP LOGIC (Speed must break threshold + buffer to count as "moving")
            // This buffer (0.5) is the secret to making it stop reliably.
            else if (spd > (stopThreshold + 0.5) && isIdling) {
                stopAndSave();
            }
        }

        function stopAndSave() {
            isIdling = false;
            clearInterval(timerInterval);
            timerEl.classList.remove('recording');
            gateStop.classList.remove('gate-active');
            gateIdle.classList.add('gate-active');
            forceBtn.classList.add('hidden');

            const finalTime = timerEl.innerText;
            // Only save if it's a real stop (over 2 seconds)
            if (parseFloat(finalTime) > 2.0) {
                console.log("Logged Stop:", finalTime);
                // Database save logic goes here
            }
            timerEl.innerText = "0.0";
        }

        document.getElementById('arm-btn').addEventListener('click', function() {
            isArmed = !isArmed;
            this.classList.toggle('btn-armed', isArmed);
            this.innerText = isArmed ? "STANDBY" : "ARM SYSTEM";
            
            if (isArmed) {
                gpsWatch = navigator.geolocation.watchPosition(processLogic, null, { 
                    enableHighAccuracy: true, 
                    maximumAge: 0 
                });
            } else {
                navigator.geolocation.clearWatch(gpsWatch);
                if (isIdling) stopAndSave();
            }
        });

        forceBtn.addEventListener('click', stopAndSave);

        document.getElementById('sense-slider').addEventListener('input', (e) => {
            stopThreshold = parseFloat(e.target.value);
        });
    </script>
</body>
</html>

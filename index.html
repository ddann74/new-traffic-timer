<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gravity Intel V5.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        :root { --accent: #00f2ff; --bg: #000; }
        body { font-family: 'JetBrains+Mono', monospace; background: var(--bg); color: var(--accent); margin: 0; overflow: hidden; height: 100vh; }
        
        .page { display: none; height: calc(100vh - 80px); width: 100vw; flex-direction: column; padding: 20px; overflow-y: auto; }
        .active-page { display: flex; }
        
        #timer-display { font-size: 28vw; font-weight: 800; line-height: 1; transition: 0.3s; }
        .is-counting { color: #ff4444; text-shadow: 0 0 25px rgba(255, 68, 68, 0.5); }
        
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 80px; background: #080808; border-top: 1px solid #1a1a1a; display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-btn { font-size: 8px; font-weight: 800; text-transform: uppercase; opacity: 0.4; display: flex; flex-direction: column; align-items: center; }
        .nav-btn-active { opacity: 1; color: var(--accent); }

        .system-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.5); }
        .gps-dot { width: 8px; height: 8px; border-radius: 50%; background: #222; }
        .gps-active { background: var(--accent); box-shadow: 0 0 10px var(--accent); }

        #map-canvas { height: 100%; width: 100%; border-radius: 12px; }
        .leaflet-tile-container { filter: invert(100%) hue-rotate(180deg) brightness(85%); }
        
        .danger-btn { border: 1px solid #441111; color: #662222; font-size: 8px; padding: 10px; border-radius: 4px; text-transform: uppercase; }
        .danger-btn:active { background: #441111; color: white; }
    </style>
</head>
<body>

    <div class="system-header">
        <div class="flex items-center gap-3">
            <div id="gps-indicator" class="gps-dot"></div>
            <span id="gps-text" class="text-[9px] font-black uppercase opacity-40">GPS_OFFLINE</span>
        </div>
        <div id="accuracy-box" class="text-[9px] font-bold">ACC: --</div>
    </div>

    <div id="page-dash" class="page active-page items-center justify-center">
        <div id="timer-display">0.0</div>
        <div id="velocity-out" class="text-[10px] opacity-40 mb-10 tracking-[0.4em]">SPEED: 0.0 M/S</div>
        <button id="arm-btn" class="border-2 border-cyan-400 px-12 py-5 rounded-full font-black uppercase text-xs">Arm System</button>
        <div class="mt-8 w-64 text-center">
            <p class="text-[8px] opacity-30 mb-2 uppercase">Sensitivity</p>
            <input type="range" id="sense-slider" min="0.2" max="1.5" step="0.1" value="0.5" class="w-full accent-cyan-400">
        </div>
    </div>

    <div id="page-map" class="page"><div id="map-canvas"></div></div>

    <div id="page-history" class="page">
        <h2 class="text-xs font-black uppercase mb-4 tracking-widest">Recent_Logs</h2>
        <div id="history-list" class="space-y-2 mb-10"></div>
    </div>

    <div id="page-leader" class="page">
        <h2 class="text-xs font-black uppercase mb-4 tracking-widest">Top_Stops</h2>
        <div id="leader-list" class="space-y-3 mb-10"></div>
        <hr class="border-zinc-900 my-6">
        <button onclick="clearAllData()" class="danger-btn">Wipe All System Data</button>
    </div>

    <nav class="nav-bar">
        <button onclick="showPage('dash')" class="nav-btn nav-btn-active" id="btn-dash"><span>DASH</span></button>
        <button onclick="showPage('map')" class="nav-btn" id="btn-map"><span>MAP</span></button>
        <button onclick="showPage('history')" class="nav-btn" id="btn-history"><span>LOGS</span></button>
        <button onclick="showPage('leader')" class="nav-btn" id="btn-leader"><span>RANK</span></button>
    </nav>

    <script>
        let db = JSON.parse(localStorage.getItem('gravity_final_db') || '[]');
        let isArmed = false, isIdling = false, startTime, timerInterval, gpsWatch;
        let lastPos = { lat: 0, lng: 0 }, stopThreshold = 0.5;
        let mapObj = null;

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-btn-active'));
            document.getElementById(`page-${pageId}`).classList.add('active-page');
            document.getElementById(`btn-${pageId}`).classList.add('nav-btn-active');
            if(pageId === 'map') initMap();
            if(pageId === 'history') renderHistory();
            if(pageId === 'leader') renderLeaderboard();
        }

        function processLogic(pos) {
            const spd = pos.coords.speed || 0;
            const acc = pos.coords.accuracy || 0;
            lastPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            document.getElementById('velocity-out').innerText = `SPEED: ${spd.toFixed(1)} M/S`;
            document.getElementById('accuracy-box').innerText = `ACC: ${acc.toFixed(0)}M`;
            
            if(acc < 25) {
                document.getElementById('gps-indicator').classList.add('gps-active');
                document.getElementById('gps-text').innerText = "GPS_LOCKED";
            }

            if (!isArmed) return;

            if (spd <= stopThreshold && !isIdling) {
                isIdling = true;
                startTime = Date.now();
                document.getElementById('timer-display').classList.add('is-counting');
                timerInterval = setInterval(() => {
                    document.getElementById('timer-display').innerText = ((Date.now() - startTime) / 1000).toFixed(1);
                }, 100);
            } 
            else if (spd > (stopThreshold + 0.6) && isIdling) {
                isIdling = false;
                clearInterval(timerInterval);
                const dur = document.getElementById('timer-display').innerText;
                document.getElementById('timer-display').classList.remove('is-counting');
                if(parseFloat(dur) > 2.0) {
                    db.push({ ts: Date.now(), dur: parseFloat(dur), lat: lastPos.lat, lng: lastPos.lng });
                    localStorage.setItem('gravity_final_db', JSON.stringify(db));
                }
                document.getElementById('timer-display').innerText = "0.0";
            }
        }

        document.getElementById('arm-btn').addEventListener('click', function() {
            isArmed = !isArmed;
            this.style.background = isArmed ? "var(--accent)" : "transparent";
            this.style.color = isArmed ? "#000" : "var(--accent)";
            this.innerText = isArmed ? "STANDBY" : "ARM SYSTEM";
            if (isArmed) {
                gpsWatch = navigator.geolocation.watchPosition(processLogic, (e) => console.log(e), { enableHighAccuracy: true });
            } else {
                navigator.geolocation.clearWatch(gpsWatch);
            }
        });

        function clearAllData() {
            if(confirm("Permanently wipe all logs?")) {
                db = [];
                localStorage.setItem('gravity_final_db', JSON.stringify(db));
                showPage('dash');
            }
        }

        function initMap() {
            setTimeout(() => {
                if(mapObj) mapObj.remove();
                mapObj = L.map('map-canvas', { zoomControl: false }).setView([lastPos.lat || 0, lastPos.lng || 0], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapObj);
                db.forEach(entry => L.circle([entry.lat, entry.lng], { color: 'cyan', radius: 10 }).addTo(mapObj));
            }, 200);
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = db.slice(-15).reverse().map(e => `
                <div class="p-3 border-b border-zinc-900 flex justify-between">
                    <span class="font-bold text-white">${e.dur}s</span>
                    <span class="opacity-30 text-[8px] uppercase">${new Date(e.ts).toLocaleTimeString()}</span>
                </div>
            `).join('');
        }

        function renderLeaderboard() {
            const list = document.getElementById('leader-list');
            const sorted = [...db].sort((a,b) => b.dur - a.dur).slice(0, 5);
            list.innerHTML = sorted.map((e, i) => `
                <div class="p-4 bg-zinc-950 border-l-2 border-cyan-400 flex justify-between items-center">
                    <div><p class="text-[8px] opacity-40 uppercase">Rank #0${i+1}</p><p class="text-xl font-black">${e.dur}s</p></div>
                    <div class="text-[7px] opacity-20 text-right">${e.lat.toFixed

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gravity Intel V17.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        :root { --accent: #00f2ff; --bg: #050505; }
        body { font-family: 'JetBrains Mono', monospace; background: var(--bg); color: var(--accent); margin: 0; overflow: hidden; height: 100vh; font-size: 18px; }
        
        /* High Contrast Map Filter */
        #map-canvas { height: 100%; width: 100%; background: #000; z-index: 10; }
        .map-brightness-tweak { filter: invert(100%) hue-rotate(180deg) brightness(0.9) contrast(1.2); }
        .leaflet-container { background: #000 !important; }

        .page { display: none; width: 100vw; height: calc(100vh - 85px); flex-direction: column; overflow-y: auto; }
        .active-page { display: flex; }
        
        /* Navigation */
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 85px; background: #000; display: grid; grid-template-columns: repeat(4, 1fr); border-top: 1px solid #222; z-index: 2000; padding-bottom: env(safe-area-inset-bottom); }
        .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.4; font-size: 13px; font-weight: 700; border: none; background: none; color: white; }
        .nav-btn-active { opacity: 1; color: var(--accent); border-top: 3px solid var(--accent); }
        
        /* Dashboard */
        #timer-display { font-size: 32vw; font-weight: 700; line-height: 1; color: #27272a; transition: color 0.3s; }
        .filter-pill { background: #111; border: 1px solid #333; padding: 8px 16px; border-radius: 20px; font-size: 12px; color: #71717a; }
        .filter-pill.active { background: var(--accent); color: black; font-weight: 800; }
        
        /* Modals & Cards */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; padding: 25px; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .log-card { transition: all 0.2s; border: 1px solid #18181b; }
        .log-card.selected { border-color: var(--accent); background: rgba(0, 242, 255, 0.05); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes pulse-purple { 0%, 100% { border-color: rgba(168, 85, 247, 0.5); } 50% { border-color: rgba(168, 85, 247, 1); } }
        .suggest-anim { animation: pulse-purple 2s infinite; }
    </style>
</head>
<body>

    <div id="page-dash" class="page active-page p-6">
        <div id="suggestion-bar" class="hidden mb-4 bg-purple-900/30 border border-purple-500/50 p-4 rounded-2xl flex justify-between items-center suggest-anim cursor-pointer">
            <span class="text-[10px] font-black text-purple-400 uppercase">Frequent Zone: Mark as Safe?</span>
            <span class="text-[10px] bg-purple-500 text-white px-3 py-1 rounded-lg font-bold">YES</span>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="bg-zinc-900 p-5 rounded-2xl border border-zinc-800">
                <span class="text-[11px] opacity-40 uppercase block mb-1">Stability</span>
                <span id="stab-percent" class="text-lg font-bold">0%</span>
            </div>
            <div class="bg-zinc-900 p-5 rounded-2xl border border-zinc-800 text-right">
                <span class="text-[11px] opacity-40 uppercase block mb-1">Velocity</span>
                <span id="speed-display" class="text-lg font-bold text-white uppercase">0.0 KM/H</span>
            </div>
        </div>
        <div class="flex-1 flex flex-col justify-center items-center text-center">
            <div id="timer-display">0.0</div>
            <div id="data-status" class="text-sm mt-6 opacity-50 font-bold uppercase tracking-widest">Initializing...</div>
            <div class="mt-12 w-full"><button id="btn-master" onclick="toggleSystem()" class="w-full py-6 bg-zinc-800 text-zinc-400 font-black rounded-3xl uppercase text-lg shadow-xl">Initiate Engine</button></div>
        </div>
    </div>

    <div id="page-map" class="page" style="padding:0; overflow:hidden; position:relative;">
        <div id="map-canvas"></div>
        <div class="absolute top-4 left-4 z-[1000]">
            <button onclick="recenterMap()" class="bg-zinc-900/90 border border-zinc-700 p-4 rounded-2xl text-[10px] font-black uppercase text-white backdrop-blur-md shadow-2xl active:scale-95 transition-transform">â—Ž Find Me</button>
        </div>
        <div class="absolute top-4 right-4 z-[1000]">
            <button onclick="toggleHeatmap()" id="heat-btn" class="bg-zinc-900/90 border border-zinc-700 p-4 rounded-2xl text-[10px] font-black uppercase text-zinc-400 backdrop-blur-md shadow-2xl">Heatmap: OFF</button>
        </div>
    </div>
    
    <div id="page-history" class="page p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-white font-black text-xl uppercase tracking-tight">Geospatial Logs</h2>
            <button id="edit-mode-btn" onclick="toggleEditMode()" class="text-[10px] font-bold border border-zinc-700 px-3 py-2 rounded-xl text-zinc-400 uppercase">Select</button>
        </div>
        <div id="bulk-actions" class="hidden mb-4 bg-zinc-900 p-3 rounded-2xl flex justify-between items-center border border-cyan-500/30">
            <span id="selected-count" class="text-xs font-bold text-cyan-500 ml-2">0 SELECTED</span>
            <button onclick="deleteSelected()" class="bg-red-500 text-white text-[10px] font-black px-4 py-2 rounded-xl uppercase">Delete Group</button>
        </div>
        <div id="history-list" class="space-y-4 pb-32"></div>
    </div>

    <div id="page-about" class="page p-6">
        <h2 class="text-white font-black text-xl uppercase mb-6 tracking-tighter">System Control</h2>
        <div class="space-y-4">
            <div class="bg-zinc-900 p-6 rounded-[32px] border border-zinc-800">
                <span class="text-[10px] opacity-40 uppercase font-black block mb-4">Data Management</span>
                <button onclick="exportToCSV()" class="w-full bg-cyan-500/10 border border-cyan-500/50 text-cyan-500 py-4 rounded-2xl font-black text-xs uppercase tracking-widest mb-3">Export Records (CSV)</button>
                <p class="text-[10px] text-zinc-500 leading-relaxed">Backup history. Records: <span id="record-count-stat">0</span></p>
            </div>
            <div class="bg-zinc-900 p-6 rounded-[32px] border border-zinc-800">
                <span class="text-[10px] opacity-40 uppercase font-black block mb-2">Build Info</span>
                <div class="text-white font-bold text-sm">V17.4 High-Visibility</div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="bg-zinc-900 w-full max-w-sm rounded-[40px] p-8 border border-zinc-800">
            <h3 class="text-white font-black text-lg mb-6 uppercase">Modify Record</h3>
            <select id="edit-category" class="w-full bg-black p-4 rounded-2xl border border-zinc-700 text-white font-bold">
                <option value="General">Standard Stop</option>
                <option value="Traffic">Traffic / Signal</option>
                <option value="SafeZone">Safe Zone</option>
            </select>
            <div class="grid grid-cols-2 gap-4 mt-10">
                <button onclick="deleteCurrentRecord()" class="bg-red-500/10 text-red-500 py-4 rounded-2xl font-black text-xs">DELETE</button>
                <button onclick="saveEdit()" class="bg-cyan-500 text-black py-4 rounded-2xl font-black text-xs">CONFIRM</button>
            </div>
            <button onclick="closeModal()" class="w-full mt-6 text-xs font-bold opacity-30 uppercase">Go Back</button>
        </div>
    </div>

    <nav class="nav-bar">
        <button onclick="tab('dash')" id="tab-dash" class="nav-btn nav-btn-active">DASH</button>
        <button onclick="tab('map')" id="tab-map" class="nav-btn">MAP</button>
        <button onclick="tab('history')" id="tab-history" class="nav-btn">LOGS</button>
        <button onclick="tab('about')" id="tab-about" class="nav-btn">SYS</button>
    </nav>

    <script>
        const DB_KEY = 'GRV_V16_MASTER';
        const STABILITY_THRESHOLD = 4;
        let storage = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
        let isArmed = false, isStopped = false, startMark = 0, timerInterval = null;
        let map, userMarker, historyGroup, heatLayer, ghostRoute = null;
        let lastCoords = { lat: 0, lon: 0 };
        let activeRecordId = null, heatActive = false, isEditMode = false;
        let selectedIds = new Set();

        function toggleSystem() {
            isArmed = !isArmed;
            const btn = document.getElementById('btn-master');
            btn.innerText = isArmed ? "ENGINE ACTIVE" : "INITIATE ENGINE";
            btn.style.backgroundColor = isArmed ? "#06b6d4" : "#27272a";
            btn.style.color = isArmed ? "#000" : "#71717a";
            if(!isArmed) stopTimer();
        }

        function updateColors(sec) {
            const display = document.getElementById('timer-display');
            const status = document.getElementById('data-status');
            const validData = storage.filter(i => i.cat !== 'SafeZone');
            if (validData.length < STABILITY_THRESHOLD) {
                display.style.color = "#3f3f46";
                status.innerText = `LEARNING: ${validData.length}/${STABILITY_THRESHOLD}`;
                return;
            }
            const avg = validData.reduce((a, b) => a + b.d, 0) / validData.length;
            if (sec <= avg * 0.8) { display.style.color = "#22c55e"; status.innerText = "OPTIMAL"; }
            else if (sec <= avg * 1.2) { display.style.color = "#f59e0b"; status.innerText = "AVERAGE"; }
            else { display.style.color = "#ef4444"; status.innerText = "DELAYED"; }
        }

        function startTimer() {
            if (isStopped || !isArmed) return;
            isStopped = true; startMark = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - startMark) / 1000;
                document.getElementById('timer-display').innerText = elapsed.toFixed(1);
                updateColors(elapsed);
            }, 100);
        }

        function stopTimer() {
            if (!isStopped) return;
            isStopped = false; clearInterval(timerInterval);
            const duration = parseFloat(((Date.now() - startMark) / 1000).toFixed(1));
            if (duration > 3) {
                storage.push({ id: Date.now(), d: duration, ts: Date.now(), lat: lastCoords.lat, lon: lastCoords.lon, cat: "General" });
                localStorage.setItem(DB_KEY, JSON.stringify(storage));
                updateDashboard();
            }
            document.getElementById('timer-display').innerText = "0.0";
            document.getElementById('timer-display').style.color = "#27272a";
        }

        function initMap() {
            if (map) return;
            map = L.map('map-canvas', { zoomControl: false, attributionControl: false }).setView([lastCoords.lat, lastCoords.lon], 16);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', {
                className: 'map-brightness-tweak'
            }).addTo(map);

            historyGroup = L.layerGroup().addTo(map);
            userMarker = L.circleMarker([lastCoords.lat, lastCoords.lon], { 
                radius: 12, color: '#fff', weight: 4, fillColor: '#00f2ff', fillOpacity: 1 
            }).addTo(map);
            renderMapData();
        }

        function recenterMap() {
            if (lastCoords.lat !== 0) map.flyTo([lastCoords.lat, lastCoords.lon], 17);
        }

        function toggleHeatmap() {
            heatActive = !heatActive;
            document.getElementById('heat-btn').innerText = heatActive ? "Heatmap: ON" : "Heatmap: OFF";
            document.getElementById('heat-btn').classList.toggle('text-orange-400', heatActive);
            renderMapData();
        }

        function renderMapData() {
            if(!historyGroup) return;
            historyGroup.clearLayers();
            if(heatLayer) map.removeLayer(heatLayer);
            if(ghostRoute) map.removeLayer(ghostRoute);

            // GHOST ROUTE (24H)
            const dayAgo = Date.now() - 86400000;
            const recent = storage.filter(i => i.ts > dayAgo).sort((a,b) => a.ts - b.ts).map(i => [i.lat, i.lon]);
            if(recent.length > 1) {
                ghostRoute = L.polyline(recent, { color: '#00f2ff', weight: 2, opacity: 0.2, dashArray: '5, 10' }).addTo(map);
            }

            if (heatActive) {
                const points = storage.map(i => [i.lat, i.lon, Math.min(i.d / 60, 1)]);
                heatLayer = L.heatLayer(points, { radius: 25, blur: 15 }).addTo(map);
            } else {
                storage.forEach(item => {
                    const isSafe = item.cat === "SafeZone";
                    L.circleMarker([item.lat, item.lon], { 
                        radius: 8, color: isSafe ? "#a855f7" : "#00f2ff", fillColor: isSafe ? "#a855f7" : "#00f2ff", fillOpacity: 0.5 
                    }).addTo(historyGroup).on('click', () => { activeRecordId = item.id; openEditModal(item); });
                });
            }
        }

        function renderLogs() {
            const list = document.getElementById('history-list');
            list.innerHTML = "";
            [...storage].reverse().forEach(i => {
                const isSel = selectedIds.has(i.id);
                const div = document.createElement('div');
                div.className = `log-card bg-zinc-900/50 p-5 rounded-3xl flex justify-between items-center ${isSel ? 'selected' : ''}`;
                div.onclick = () => { 
                    if(isEditMode) { 
                        if(isSel) selectedIds.delete(i.id); else selectedIds.add(i.id); 
                        document.getElementById('selected-count').innerText = `${selectedIds.size} SELECTED`; 
                        renderLogs(); 
                    } else { activeRecordId = i.id; openEditModal(i); } 
                };
                div.innerHTML = `<div class="flex items-center gap-4"><div class="w-1 h-8 rounded-full ${i.cat === 'SafeZone' ? 'bg-purple-500' : 'bg-cyan-500'}"></div><div><div class="text-white font-bold">${i.d}s</div><div class="text-[10px] opacity-30">${new Date(i.ts).toLocaleTimeString()}</div></div></div>`;
                list.appendChild(div);
            });
        }

        function exportToCSV() {
            const headers = ["ID", "Duration_Sec", "Timestamp", "Lat", "Lon", "Category"];
            const csvRows = [headers.join(",")];
            storage.forEach(i => csvRows.push([i.id, i.d, new Date(i.ts).toISOString(), i.lat, i.lon, i.cat].join(",")));
            const blob = new Blob([csvRows.join("\n")], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `gravity_intel_${Date.now()}.csv`;
            a.click();
        }

        function tab(n) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-btn-active'));
            document.getElementById('page-'+n).classList.add('active-page');
            document.getElementById('tab-'+n).classList.add('nav-btn-active');
            if(n === 'map') { initMap(); setTimeout(() => map.invalidateSize(), 200); }
            if(n === 'history') renderLogs();
        }

        navigator.geolocation.watchPosition(pos => {
            lastCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            const speed = (pos.coords.speed || 0) * 3.6;
            document.getElementById('speed-display').innerText = speed.toFixed(1) + " KM/H";
            if (isArmed && speed < 1.0 && !isStopped) startTimer();
            if (isStopped && speed > 5.0) stopTimer();
            if (userMarker) userMarker.setLatLng([lastCoords.lat, lastCoords.lon]);
        }, null, { enableHighAccuracy: true });

        function updateDashboard() {
            const validData = storage.filter(i => i.cat !== 'SafeZone');
            document.getElementById('stab-percent').innerText = Math.min((validData.length / STABILITY_THRESHOLD) * 100, 100).toFixed(0) + "%";
            document.getElementById('record-count-stat').innerText = storage.length;
            if(map) renderMapData();
        }

        function openEditModal(item) { document.getElementById('edit-category').value = item.cat; document.getElementById('edit-modal').classList.add('active'); }
        function closeModal() { document.getElementById('edit-modal').classList.remove('active'); }
        function saveEdit() { const idx = storage.findIndex(i => i.id === activeRecordId); if(idx !== -1) { storage[idx].cat = document.getElementById('edit-category').value; localStorage.setItem(DB_KEY, JSON.stringify(storage)); updateDashboard(); } closeModal(); }
        function deleteCurrentRecord() { storage = storage.filter(i => i.id !== activeRecordId); localStorage.setItem(DB_KEY, JSON.stringify(storage)); updateDashboard(); closeModal(); }
        function toggleEditMode() { isEditMode = !isEditMode; selectedIds.clear(); document.getElementById('edit-mode-btn').innerText = isEditMode ? "Cancel" : "Select"; document.getElementById('bulk-actions').classList.toggle('hidden', !isEditMode); renderLogs(); }
        function deleteSelected() { if(confirm("Delete selected?")) { storage = storage.filter(i => !selectedIds.has(i.id)); localStorage.setItem(DB_KEY, JSON.stringify(storage)); toggleEditMode(); updateDashboard(); } }

        updateDashboard();
    </script>
</body>
</html>
